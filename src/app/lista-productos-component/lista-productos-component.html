<div class="lista-productos-container">
  <!-- Header -->
  <div class="header-productos">
    <div class="d-flex justify-content-between align-items-center">
      <h2>
        <i class="fas fa-boxes me-2"></i>Gestión de Productos
      </h2>
      <button class="btn btn-productos btn-volver" (click)="volverInicio()">
        <i class="fas fa-arrow-left me-2"></i>Volver al Inicio
      </button>
    </div>
  </div>

  <!-- Botón para crear nuevo producto -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="text-dark mb-0">
      <i class="fas fa-list me-2"></i>Inventario de Productos
    </h4>
    <button class="btn btn-productos btn-crear" (click)="mostrarFormulario()" 
            *ngIf="!mostrarFormularioCrear">
      <i class="fas fa-plus-circle me-2"></i>Crear Nuevo Producto
    </button>
  </div>

  <!-- Formulario de creación -->
  <div *ngIf="mostrarFormularioCrear" class="formulario-crear">
    <h4>
      <i class="fas fa-plus-circle me-2"></i>Registrar Nuevo Producto
    </h4>
    
    <form id="productoForm">
      <div class="row">
        <div class="col-md-6">
          <div class="form-group mb-3">
            <label class="form-label fw-bold">Código del Producto *</label>
            <input type="text" class="form-control form-control-edit" 
                   [(ngModel)]="nuevoProducto.codigo" name="codigo" required
                   placeholder="Ej: PROD-001">
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group mb-3">
            <label class="form-label fw-bold">Nombre del Producto *</label>
            <input type="text" class="form-control form-control-edit" 
                   [(ngModel)]="nuevoProducto.nombre" name="nombre" required
                   placeholder="Ingrese el nombre del producto">
          </div>
        </div>
      </div>

      <div class="form-group mb-3">
        <label class="form-label fw-bold">Descripción</label>
        <textarea class="form-control form-control-edit" 
                  [(ngModel)]="nuevoProducto.descripcion" name="descripcion"
                  rows="3" placeholder="Descripción detallada del producto"></textarea>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="form-group mb-3">
            <label class="form-label fw-bold">Categoría *</label>
            <select class="form-select form-control-edit" 
                    [(ngModel)]="nuevoProducto.categoria" 
                    name="categoria"
                    required>
              <option [ngValue]="null">Seleccionar categoría</option>
              <option *ngFor="let cat of categorias" [ngValue]="cat">
                {{ cat.nombre }}
              </option>
            </select>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group mb-3">
            <label class="form-label fw-bold">Unidad de Medida *</label>
            <select class="form-select form-control-edit" 
                    [(ngModel)]="nuevoProducto.unidad" 
                    name="unidad"
                    required>
              <option [ngValue]="null">Seleccionar unidad</option>
              <option *ngFor="let uni of unidades" [ngValue]="uni">
                {{ uni.nombre }} ({{ uni.simbolo }})
              </option>
            </select>
          </div>
        </div>
      </div>

      <!-- Sección de precios -->
      <div class="precios-container mb-4">
        <h6 class="fw-bold mb-3">
          <i class="fas fa-dollar-sign me-2"></i>Información de Precios
        </h6>
        
        <div class="row">
          <div class="col-md-4">
            <div class="precio-item">
              <label class="form-label fw-bold">Precio de Costo *</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" step="0.01" class="form-control form-control-edit" 
                       [(ngModel)]="nuevoProducto.precioCosto" name="precioCosto" required
                       (input)="calcularPrecioVenta()"
                       placeholder="0.00" min="0">
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="precio-item">
              <label class="form-label fw-bold">Precio de Venta *</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" step="0.01" class="form-control form-control-edit" 
                       [(ngModel)]="nuevoProducto.precioVenta" name="precioVenta" required
                       placeholder="0.00" min="0">
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="precio-item">
              <label class="form-label fw-bold">Stock Mínimo</label>
              <input type="number" class="form-control form-control-edit" 
                     [(ngModel)]="nuevoProducto.stockMinimo" name="stockMinimo"
                     placeholder="0" min="0">
            </div>
          </div>
        </div>
        
        <div class="mt-2">
          <button type="button" class="btn btn-productos btn-calcular btn-sm" 
                  (click)="calcularPrecioVenta()">
            <i class="fas fa-calculator me-1"></i>Calcular Precio Venta (30% margen)
          </button>
        </div>
      </div>

      <div class="d-flex gap-2">
        <button type="button" class="btn btn-productos btn-guardar" 
                (click)="crearProducto()">
          <i class="fas fa-save me-2"></i>Guardar Producto
        </button>
        <button type="button" class="btn btn-productos btn-cancelar" 
                (click)="cancelarCreacion()">
          <i class="fas fa-times me-2"></i>Cancelar
        </button>
      </div>
    </form>
  </div>

  <!-- Mensaje cuando no hay productos -->
  <div *ngIf="productos.length === 0 && !mostrarFormularioCrear" class="alert alert-info-custom text-center">
    <i class="fas fa-box-open fa-4x mb-3"></i>
    <h4 class="text-dark">No hay productos registrados</h4>
    <p class="mb-0 text-muted">Haz click en "Crear Nuevo Producto" para agregar el primer producto al inventario</p>
  </div>

  <!-- Tabla de productos -->
  <div *ngIf="productos.length > 0" class="card-productos">
    <div class="card-header">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fas fa-list me-2"></i>Lista de Productos 
          <span class="badge bg-light ms-2">{{ productos.length }}</span>
        </h5>
        <small><i class="fas fa-info-circle me-1"></i>Gestiona el inventario de productos</small>
      </div>
    </div>
    
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-productos">
          <thead>
            <tr>
              <th width="12%">Código</th>
              <th width="18%">Nombre</th>
              <th width="15%">Categoría</th>
              <th width="10%">Precio Costo</th>
              <th width="10%">Precio Venta</th>
              <th width="10%">Stock Mínimo</th>
              <th width="10%">Estado</th>
              <th width="15%">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let producto of productos" 
                [class.editing-row]="modoEdicion && productoEditando?.idProducto === producto.idProducto">
              
              <!-- Modo edición -->
              <td *ngIf="modoEdicion && productoEditando?.idProducto === producto.idProducto">
                <input type="text" class="form-control form-control-edit" 
                       [(ngModel)]="productoEditando.codigo" placeholder="Código">
              </td>
              <td *ngIf="modoEdicion && productoEditando?.idProducto === producto.idProducto">
                <input type="text" class="form-control form-control-edit" 
                       [(ngModel)]="productoEditando.nombre" placeholder="Nombre">
              </td>
              <td *ngIf="modoEdicion && productoEditando?.idProducto === producto.idProducto">
                <select class="form-select form-control-edit" 
                        [(ngModel)]="productoEditando.categoria">
                  <option [ngValue]="null">Seleccionar categoría</option>
                  <option *ngFor="let cat of categorias" [ngValue]="cat"
                          [selected]="cat.idCategoria === productoEditando.categoria?.idCategoria">
                    {{ cat.nombre }}
                  </option>
                </select>
              </td>
              <td *ngIf="modoEdicion && productoEditando?.idProducto === producto.idProducto">
                <div class="input-group input-group-sm">
                  <span class="input-group-text">$</span>
                  <input type="number" step="0.01" class="form-control form-control-edit" 
                         [(ngModel)]="productoEditando.precioCosto"
                         (input)="calcularPrecioVentaEdicion()">
                </div>
              </td>
              <td *ngIf="modoEdicion && productoEditando?.idProducto === producto.idProducto">
                <div class="input-group input-group-sm">
                  <span class="input-group-text">$</span>
                  <input type="number" step="0.01" class="form-control form-control-edit" 
                         [(ngModel)]="productoEditando.precioVenta">
                </div>
              </td>
              <td *ngIf="modoEdicion && productoEditando?.idProducto === producto.idProducto">
                <input type="number" class="form-control form-control-edit" 
                       [(ngModel)]="productoEditando.stockMinimo" placeholder="Stock mínimo">
              </td>
              <td *ngIf="modoEdicion && productoEditando?.idProducto === producto.idProducto">
                <select class="form-select form-control-edit" 
                        [(ngModel)]="productoEditando.estado.id_estado">
                  <option [value]="1">Activo</option>
                  <option [value]="2">Inactivo</option>
                </select>
              </td>
              <td *ngIf="modoEdicion && productoEditando?.idProducto === producto.idProducto">
                <div class="d-flex gap-2">
                  <button class="btn btn-productos btn-guardar" (click)="guardarEdicion()">
                    <i class="fas fa-check me-1"></i>Guardar
                  </button>
                  <button class="btn btn-productos btn-cancelar" (click)="cancelarEdicion()">
                    <i class="fas fa-times me-1"></i>Cancelar
                  </button>
                </div>
              </td>

              <!-- Modo visualización normal -->
              <td *ngIf="!modoEdicion || productoEditando?.idProducto !== producto.idProducto">
                <span class="codigo-producto">{{ producto.codigo }}</span>
              </td>
              <td *ngIf="!modoEdicion || productoEditando?.idProducto !== producto.idProducto">
                <strong>{{ producto.nombre }}</strong>
                <div *ngIf="producto.descripcion" class="text-muted small">
                  {{ producto.descripcion | slice:0:50 }}{{ producto.descripcion.length > 50 ? '...' : '' }}
                </div>
              </td>
              <td *ngIf="!modoEdicion || productoEditando?.idProducto !== producto.idProducto">
                <span *ngIf="producto.categoria" class="badge-categoria">
                  {{ producto.categoria.nombre }}
                </span>
                <span *ngIf="!producto.categoria" class="text-muted small">
                  Sin categoría
                </span>
                <div *ngIf="producto.unidad" class="text-muted small">
                  {{ producto.unidad.nombre }} ({{ producto.unidad.simbolo }})
                </div>
              </td>
              <td *ngIf="!modoEdicion || productoEditando?.idProducto !== producto.idProducto">
                <span class="precio-text costo">${{ producto.precioCosto | number:'1.2-2' }}</span>
              </td>
              <td *ngIf="!modoEdicion || productoEditando?.idProducto !== producto.idProducto">
                <span class="precio-text">${{ producto.precioVenta | number:'1.2-2' }}</span>
              </td>
              <td *ngIf="!modoEdicion || productoEditando?.idProducto !== producto.idProducto">
                <span [class]="producto.stockMinimo > 0 ? 'stock-alert' : 'stock-alert good'">
                  {{ producto.stockMinimo || 0 }}
                </span>
              </td>
              <td *ngIf="!modoEdicion || productoEditando?.idProducto !== producto.idProducto">
                <span [class]="getEstadoClase(producto.estado)">
                  {{ getEstadoTexto(producto.estado) }}
                </span>
              </td>
              <td *ngIf="!modoEdicion || productoEditando?.idProducto !== producto.idProducto">
                <div class="d-flex gap-2">
                  <button class="btn btn-productos btn-editar" 
                          (click)="iniciarEdicion(producto)" 
                          [disabled]="modoEdicion">
                    <i class="fas fa-edit me-1"></i>Editar
                  </button>
                  <button class="btn btn-productos btn-eliminar" 
                          (click)="eliminarProducto(producto.idProducto)" 
                          [disabled]="modoEdicion">
                    <i class="fas fa-trash me-1"></i>Eliminar
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Información adicional -->
  <div class="mt-4">
    <div class="alert alert-light border rounded-3">
      <small class="text-muted">
        <i class="fas fa-info-circle me-1"></i>
        <strong>Nota:</strong> Los productos inactivos no estarán disponibles para ventas. 
        El sistema calcula automáticamente el precio de venta con un 30% de margen sobre el precio de costo.
        Los catálogos de categorías y unidades se cargan desde la base de datos.
      </small>
    </div>
  </div>
</div>