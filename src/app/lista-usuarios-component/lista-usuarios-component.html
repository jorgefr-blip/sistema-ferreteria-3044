<div class="lista-usuarios-container">
  <!-- Header -->
  <div class="header-usuarios">
    <div class="d-flex justify-content-between align-items-center">
      <h2>
        <i class="fas fa-users-cog me-2"></i>Gestión de Usuarios
      </h2>
      <button class="btn btn-usuarios btn-volver" (click)="volverInicio()">
        <i class="fas fa-arrow-left me-2"></i>Volver al Inicio
      </button>
    </div>
  </div>

  <!-- Botón para crear nuevo usuario -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="text-dark mb-0">
      <i class="fas fa-list me-2"></i>Usuarios del Sistema
    </h4>
    <button class="btn btn-usuarios btn-crear" (click)="mostrarFormulario()" 
            *ngIf="!mostrarFormularioCrear">
      <i class="fas fa-user-plus me-2"></i>Crear Nuevo Usuario
    </button>
  </div>

  <!-- Formulario de creación -->
  <div *ngIf="mostrarFormularioCrear" class="formulario-crear">
    <h4>
      <i class="fas fa-user-plus me-2"></i>Registrar Nuevo Usuario
    </h4>
    
    <form id="usuarioForm">
      <div class="row">
        <div class="col-md-6">
          <div class="form-group mb-3">
            <label class="form-label fw-bold">Nombre Completo *</label>
            <input type="text" class="form-control form-control-edit" 
                   [(ngModel)]="nuevoUsuario.nombre" name="nombre" required
                   placeholder="Ingrese el nombre completo">
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group mb-3">
            <label class="form-label fw-bold">Correo Electrónico *</label>
            <input type="email" class="form-control form-control-edit" 
                   [(ngModel)]="nuevoUsuario.correo" name="correo" required
                   placeholder="ejemplo@correo.com">
          </div>
        </div>
      </div>

      <div class="form-group mb-3">
        <label class="form-label fw-bold">Contraseña *</label>
        <input type="password" class="form-control form-control-edit" 
               [(ngModel)]="nuevoUsuario.contrasenia" name="contrasenia" required
               placeholder="Ingrese una contraseña segura">
      </div>

      <div class="form-group mb-4">
        <label class="form-label fw-bold">Roles del Usuario *</label>
        <div class="roles-container">
          <div class="row">
            <div class="col-md-6" *ngFor="let rol of rolesDisponibles">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" 
                       [id]="'rol_crear_' + rol.idRol"
                       [checked]="rol.seleccionado"
                       (change)="toggleRolCreacion(rol)">
                <label class="form-check-label" [for]="'rol_crear_' + rol.idRol">
                  {{ rol.nombre }}
                </label>
              </div>
            </div>
          </div>
        </div>
        <small class="text-muted">Selecciona al menos un rol para el usuario</small>
      </div>

      <div class="d-flex gap-2">
        <button type="button" class="btn btn-usuarios btn-guardar" 
                (click)="crearUsuario()"
                [disabled]="nuevoUsuario.roles.length === 0">
          <i class="fas fa-save me-2"></i>Guardar Usuario
        </button>
        <button type="button" class="btn btn-usuarios btn-cancelar" 
                (click)="cancelarCreacion()">
          <i class="fas fa-times me-2"></i>Cancelar
        </button>
      </div>
    </form>
  </div>

  <!-- Mensaje cuando no hay usuarios -->
  <div *ngIf="usuarios.length === 0 && !mostrarFormularioCrear" class="alert alert-info-custom text-center">
    <i class="fas fa-user-slash fa-4x mb-3"></i>
    <h4 class="text-dark">No hay usuarios registrados</h4>
    <p class="mb-0 text-muted">Haz click en "Crear Nuevo Usuario" para agregar el primer usuario</p>
  </div>

  <!-- Tabla de usuarios -->
  <div *ngIf="usuarios.length > 0" class="card-usuarios">
    <div class="card-header">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fas fa-list me-2"></i>Lista de Usuarios 
          <span class="badge bg-light ms-2">{{ usuarios.length }}</span>
        </h5>
        <small><i class="fas fa-info-circle me-1"></i>Gestiona los usuarios del sistema</small>
      </div>
    </div>
    
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-usuarios">
          <thead>
            <tr>
              <th width="20%">Nombre</th>
              <th width="20%">Correo</th>
              <th width="25%">Roles</th>
              <th width="15%">Estado</th>
              <th width="20%">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let usuario of usuarios" 
                [class.editing-row]="modoEdicion && usuarioEditando?.idUsuario === usuario.idUsuario">
              
              <!-- Modo edición -->
              <td *ngIf="modoEdicion && usuarioEditando?.idUsuario === usuario.idUsuario">
                <input type="text" class="form-control form-control-edit" 
                       [(ngModel)]="usuarioEditando.nombre" placeholder="Nombre completo">
              </td>
              <td *ngIf="modoEdicion && usuarioEditando?.idUsuario === usuario.idUsuario">
                <input type="email" class="form-control form-control-edit" 
                       [(ngModel)]="usuarioEditando.correo" placeholder="Correo electrónico">
              </td>
              <td *ngIf="modoEdicion && usuarioEditando?.idUsuario === usuario.idUsuario">
                <div class="roles-container">
                  <div class="row">
                    <div class="col-6" *ngFor="let rol of rolesDisponibles">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" 
                               [id]="'rol_edit_' + rol.idRol + '_' + usuario.idUsuario"
                               [checked]="rol.seleccionado"
                               (change)="toggleRolEdicion(rol)">
                        <label class="form-check-label" [for]="'rol_edit_' + rol.idRol + '_' + usuario.idUsuario">
                          {{ rol.nombre }}
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
              <td *ngIf="modoEdicion && usuarioEditando?.idUsuario === usuario.idUsuario">
                <select class="form-select form-control-edit" [(ngModel)]="usuarioEditando.idEstado">
                  <option [value]="1">Activo</option>
                  <option [value]="2">Inactivo</option>
                </select>
              </td>
              <td *ngIf="modoEdicion && usuarioEditando?.idUsuario === usuario.idUsuario">
                <div class="d-flex gap-2">
                  <button class="btn btn-usuarios btn-guardar" (click)="guardarEdicion()">
                    <i class="fas fa-check me-1"></i>Guardar
                  </button>
                  <button class="btn btn-usuarios btn-cancelar" (click)="cancelarEdicion()">
                    <i class="fas fa-times me-1"></i>Cancelar
                  </button>
                </div>
              </td>

              <!-- Modo visualización normal -->
              <td *ngIf="!modoEdicion || usuarioEditando?.idUsuario !== usuario.idUsuario">
                <strong>{{ usuario.nombre }}</strong>
              </td>
              <td *ngIf="!modoEdicion || usuarioEditando?.idUsuario !== usuario.idUsuario">
                {{ usuario.correo }}
              </td>
              <td *ngIf="!modoEdicion || usuarioEditando?.idUsuario !== usuario.idUsuario">
                <div class="d-flex flex-wrap gap-1">
                  <span *ngFor="let rol of usuario.roles" class="badge-rol">
                    {{ rol.nombre }}
                  </span>
                  <span *ngIf="!usuario.roles || usuario.roles.length === 0" class="text-muted">
                    Sin roles
                  </span>
                </div>
              </td>
              <td *ngIf="!modoEdicion || usuarioEditando?.idUsuario !== usuario.idUsuario">
                <span [class]="getEstadoClase(usuario.idEstado)">
                  {{ getEstadoTexto(usuario.idEstado) }}
                </span>
              </td>
              <td *ngIf="!modoEdicion || usuarioEditando?.idUsuario !== usuario.idUsuario">
                <div class="d-flex gap-2">
                  <button class="btn btn-usuarios btn-editar" 
                          (click)="iniciarEdicion(usuario)" 
                          [disabled]="modoEdicion">
                    <i class="fas fa-edit me-1"></i>Editar
                  </button>
                  
                  <button *ngIf="usuario.idEstado === 1" 
                          class="btn btn-usuarios btn-eliminar" 
                          (click)="eliminarUsuario(usuario.idUsuario)" 
                          [disabled]="modoEdicion">
                    <i class="fas fa-ban me-1"></i>Dar de Baja
                  </button>
                  
                  <button *ngIf="usuario.idEstado === 2" 
                          class="btn btn-usuarios btn-activar" 
                          (click)="activarUsuario(usuario.idUsuario)" 
                          [disabled]="modoEdicion">
                    <i class="fas fa-check me-1"></i>Activar
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Información adicional -->
  <div class="mt-4">
    <div class="alert alert-light border rounded-3">
      <small class="text-muted">
        <i class="fas fa-info-circle me-1"></i>
        <strong>Nota:</strong> Solo los usuarios con rol de Administrador pueden gestionar otros usuarios. 
        Al dar de baja un usuario, este no podrá acceder al sistema hasta que sea activado nuevamente.
      </small>
    </div>
  </div>
</div>