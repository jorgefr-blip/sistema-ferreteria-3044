<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1 text-primary">Gestión de Compras</h1>
      <p class="text-muted mb-0">Administra las compras a proveedores</p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-primary" (click)="mostrarFormulario()">
        <i class="fas fa-plus me-2"></i>Nueva Compra
      </button>
      <button class="btn btn-outline-secondary" (click)="volverInicio()">
        <i class="fas fa-home me-2"></i>Inicio
      </button>
    </div>
  </div>

  <!-- Formulario de Creación -->
  <div *ngIf="mostrarFormularioCrear" class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="card-title mb-0">
        <i class="fas fa-shopping-cart me-2"></i>Nueva Compra
      </h5>
    </div>
    <div class="card-body">
      <form id="compraForm">
        <div class="row g-3">
          <!-- Proveedor -->
          <div class="col-md-6">
            <label class="form-label">Proveedor *</label>
            <select class="form-select" [(ngModel)]="nuevaCompra.proveedor" name="proveedor" required>
              <option value="">Seleccionar proveedor...</option>
              <option *ngFor="let proveedor of proveedores" [ngValue]="proveedor">
                {{ proveedor.nombre }}
              </option>
            </select>
          </div>

          <!-- Sucursal -->
          <div class="col-md-6">
            <label class="form-label">Sucursal *</label>
            <select class="form-select" [(ngModel)]="nuevaCompra.sucursal" name="sucursal" required>
              <option value="">Seleccionar sucursal...</option>
              <option *ngFor="let sucursal of sucursales" [ngValue]="sucursal">
                {{ sucursal.nombre }} - {{ sucursal.region?.nombre }}
              </option>
            </select>
          </div>

          <!-- Fecha -->
          <div class="col-md-6">
            <label class="form-label">Fecha *</label>
            <input type="datetime-local" class="form-control" [(ngModel)]="nuevaCompra.fecha" name="fecha" required>
          </div>

          <!-- Estado -->
          <div class="col-md-6">
            <label class="form-label">Estado</label>
            <select class="form-select" [(ngModel)]="nuevaCompra.estado" name="estado">
              <option *ngFor="let estado of estados" [ngValue]="estado">
                {{ estado.nombre }}
              </option>
            </select>
          </div>
        </div>

        <!-- Sección para agregar productos -->
        <div class="mt-4">
          <h6 class="border-bottom pb-2">Agregar Productos</h6>
          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <label class="form-label">Producto</label>
              <select class="form-select" [(ngModel)]="productoSeleccionado" name="producto" (change)="onProductoSeleccionado()">
                <option value="">Seleccionar producto...</option>
                <option *ngFor="let producto of productos" [ngValue]="producto">
                  {{ producto.codigo }} - {{ producto.nombre }}
                </option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Cantidad</label>
              <input type="number" class="form-control" [(ngModel)]="cantidad" name="cantidad" min="1">
            </div>
            <div class="col-md-3">
              <label class="form-label">Precio Unitario (Q)</label>
              <input type="number" class="form-control" [(ngModel)]="precio" name="precio" step="0.01" min="0">
            </div>
            <div class="col-md-3">
              <button type="button" class="btn btn-success w-100" (click)="agregarProducto()">
                <i class="fas fa-plus me-2"></i>Agregar
              </button>
            </div>
          </div>
        </div>

        <!-- Tabla de productos agregados -->
        <div *ngIf="detallesTemporales.length > 0" class="mt-4">
          <h6 class="border-bottom pb-2">Productos en la Compra</h6>
          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Código</th>
                  <th>Cantidad</th>
                  <th>Precio Unitario</th>
                  <th>Subtotal</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let detalle of detallesTemporales; let i = index">
                  <td>{{ detalle.producto.nombre }}</td>
                  <td>{{ detalle.producto.codigo }}</td>
                  <td>{{ detalle.cantidad }}</td>
                  <td>{{ formatearMoneda(detalle.precio) }}</td>
                  <td>{{ formatearMoneda(detalle.subtotal) }}</td>
                  <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" (click)="eliminarProductoDetalle(i)">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr class="table-primary">
                  <td colspan="4" class="text-end fw-bold">Total:</td>
                  <td colspan="2" class="fw-bold">{{ formatearMoneda(nuevaCompra.total) }}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- Botones del formulario -->
        <div class="d-flex gap-2 mt-4">
          <button type="button" class="btn btn-success" (click)="crearCompra()" [disabled]="detallesTemporales.length === 0">
            <i class="fas fa-save me-2"></i>Guardar Compra
          </button>
          <button type="button" class="btn btn-secondary" (click)="cancelarCreacion()">
            <i class="fas fa-times me-2"></i>Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Lista de Compras -->
  <div class="card">
    <div class="card-header bg-light">
      <h5 class="card-title mb-0">
        <i class="fas fa-list me-2"></i>Lista de Compras
      </h5>
    </div>
    <div class="card-body">
      <div *ngIf="compras.length === 0" class="text-center py-4">
        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
        <p class="text-muted">No hay compras registradas</p>
      </div>

      <div *ngIf="compras.length > 0" class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>ID</th>
              <th>Proveedor</th>
              <th>Sucursal</th>
              <th>Fecha</th>
              <th>Total</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let compra of compras">
              <td>{{ compra.idCompra }}</td>
              <td>{{ compra.proveedor?.nombre }}</td>
              <td>{{ compra.sucursal?.nombre }}</td>
              <td>{{ formatearFecha(compra.fecha) }}</td>
              <td>{{ formatearMoneda(compra.total) }}</td>
              <td>
                <span [class]="getEstadoClase(compra.estado)">
                  {{ getEstadoTexto(compra.estado) }}
                </span>
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary" (click)="verDetalles(compra)">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn btn-outline-danger" (click)="eliminarCompra(compra.idCompra)">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal de Detalles -->
  <div *ngIf="modoEdicion && compraEditando" class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5)" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="fas fa-info-circle me-2"></i>Detalles de Compra #{{ compraEditando.idCompra }}
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="cancelarEdicion()"></button>
        </div>
        <div class="modal-body">
          <!-- Información básica de la compra -->
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="mb-2">
                <strong>Proveedor:</strong> {{ compraEditando.proveedor?.nombre }}
              </div>
              <div class="mb-2">
                <strong>Contacto:</strong> {{ compraEditando.proveedor?.contacto }}
              </div>
              <div class="mb-2">
                <strong>Email:</strong> {{ compraEditando.proveedor?.email }}
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-2">
                <strong>Sucursal:</strong> {{ compraEditando.sucursal?.nombre }}
              </div>
              <div class="mb-2">
                <strong>Dirección:</strong> {{ compraEditando.sucursal?.direccion }}
              </div>
              <div class="mb-2">
                <strong>Teléfono:</strong> {{ compraEditando.sucursal?.telefono }}
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-4">
              <strong>Fecha:</strong> {{ formatearFecha(compraEditando.fecha) }}
            </div>
            <div class="col-md-4">
              <strong>Total:</strong> {{ formatearMoneda(compraEditando.total) }}
            </div>
            <div class="col-md-4">
              <strong>Estado:</strong> 
              <span [class]="getEstadoClase(compraEditando.estado)">
                {{ getEstadoTexto(compraEditando.estado) }}
              </span>
            </div>
          </div>
          
          <!-- Detalles de productos -->
          <div *ngIf="detallesCompraEditando.length > 0">
            <h6 class="border-bottom pb-2">Productos Comprados</h6>
            <div class="table-responsive">
              <table class="table table-sm table-striped">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Código</th>
                    <th>Categoría</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let detalle of detallesCompraEditando">
                    <td>{{ detalle.producto?.nombre }}</td>
                    <td>{{ detalle.producto?.codigo }}</td>
                    <td>{{ detalle.producto?.categoria?.nombre }}</td>
                    <td>{{ detalle.cantidad }}</td>
                    <td>{{ formatearMoneda(detalle.precio) }}</td>
                    <td>{{ formatearMoneda(detalle.subtotal) }}</td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr class="table-primary">
                    <td colspan="5" class="text-end fw-bold">Total Compra:</td>
                    <td class="fw-bold">{{ formatearMoneda(compraEditando.total) }}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div *ngIf="detallesCompraEditando.length === 0" class="text-center py-3">
            <i class="fas fa-box-open fa-2x text-muted mb-2"></i>
            <p class="text-muted mb-0">No hay detalles de productos para esta compra</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="cancelarEdicion()">
            <i class="fas fa-times me-2"></i>Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>